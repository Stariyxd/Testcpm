<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏: Car Parking Multiplayer</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ */
        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem; 
            font-weight: 600;
            text-transform: uppercase;
        }
        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞—è–≤–æ–∫ */
        .status-pending { background-color: #FBBF24; color: #422006; } /* amber */
        .status-in_progress { background-color: #3B82F6; color: #EFF6FF; } /* blue */
        .status-ready_to_receive { background-color: #10B981; color: #ECFDF5; } /* green */
        .status-client_ready { background-color: #9333ea; color: #ffffff; } /* purple (–∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª) */
        .status-completed { background-color: #4B5563; color: #E5E7EB; } /* gray */

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            min-width: 300px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-xl mx-auto">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-600">–û—á–µ—Ä–µ–¥—å Car Parking Multiplayer</h1>
            <p id="current-server-message" class="text-gray-500 font-medium mt-2">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </header>

        <!-- –ë–ª–æ–∫ "–ú–æ—è –∑–∞—è–≤–∫–∞" -->
        <div id="my-request-card" class="bg-white p-6 rounded-lg shadow-xl mb-8 border-t-4 border-blue-500">
            <h2 class="text-xl font-bold mb-4 text-blue-600">–ú–æ—è –¢–µ–∫—É—â–∞—è –ó–∞—è–≤–∫–∞</h2>
            
            <!-- –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div id="request-display" class="hidden">
                <p class="text-sm font-medium text-gray-700">–í–∞—à ID (–¥–ª—è —Å–≤—è–∑–∏): <span id="user-id-display" class="font-mono text-sm bg-gray-100 p-1 rounded"></span></p>
                <p class="text-lg font-bold mt-3">–ó–∞–ø—Ä–æ—Å:</p>
                <p id="request-details-display" class="text-gray-800 break-words mb-3"></p>
                
                <p class="text-lg font-bold">–°—Ç–∞—Ç—É—Å:</p>
                <span id="request-status-tag" class="status-tag"></span>
                
                <div id="ready-to-receive-actions" class="mt-4 pt-4 border-t border-gray-200 hidden">
                    <p class="text-purple-600 font-semibold mb-2">üéâ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é!</p>
                    <button id="im-ready-btn" class="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150 disabled:opacity-50">
                        –Ø –≤ –∏–≥—Ä–µ, –≥–æ—Ç–æ–≤ –∑–∞–±—Ä–∞—Ç—å!
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">–ù–∞–∂–º–∏—Ç–µ, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</p>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ (–ø–æ–∫–∞–∑–∞–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div id="new-request-form">
                <p id="form-header-message" class="text-red-500 mb-4 font-semibold hidden"></p>
                <p class="text-sm text-gray-500 mb-2">–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ, —Ç—é–Ω–∏–Ω–≥, –ø—Ä–æ—à–∏–≤–∫–∞).</p>
                <textarea id="request-input" rows="3" placeholder="–ü—Ä–∏–º–µ—Ä: Bugatti Divo (—Ñ—É–ª–ª —Ç—é–Ω–∏–Ω–≥, –ø—Ä–æ—à–∏–≤–∫–∞ 400 –ª.—Å.)"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                
                <button id="submit-request-btn" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 mt-3 disabled:opacity-50">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞—è–≤–∫—É –≤ –û—á–µ—Ä–µ–¥—å
                </button>
                <p class="text-xs text-gray-500 mt-3 text-center">
                    –ê–¥–º–∏–Ω–∞–º —Å—é–¥–∞: <a href="admin/index.html" class="text-blue-500 hover:underline">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                </p>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <button id="delete-request-btn" class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 mt-4 hidden">
                –£–¥–∞–ª–∏—Ç—å –ó–∞—è–≤–∫—É
            </button>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ñ—Ñ–ª–∞–π–Ω -->
        <div id="offline-message" class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg hidden">
            <p class="font-bold">–°–µ—Ä–≤–µ—Ä –û—Ñ—Ñ–ª–∞–π–Ω</p>
            <p>–°–µ–π—á–∞—Å —Ä–∞–∑–¥–∞—á–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É, –Ω–æ –æ–Ω–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ø–æ–∑–∂–µ.</p>
        </div>
        
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <div id="custom-modal-container"></div>

    <!-- –ú–æ–¥—É–ª—å Firebase -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            query, 
            where, 
            deleteDoc,
            updateDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let db;
        let auth;
        let userId; 
        let userDocRef; // –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏
        let statusDocRef; // –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
        let isServerOnline = true;
        
        // --- !!! –í–ê–ñ–ù–û: –í–ê–®–ò –ö–õ–Æ–ß–ò FIREBASE !!! ---
        const firebaseConfig = {
            apiKey: "AIzaSyBw_8Dx9gUI5tsUXSqX4Jd8hfjU4pNZGI8",
                    authDomain: "cpm-giveaway.firebaseapp.com",
                    projectId: "cpm-giveaway", 
        };
        const appId = firebaseConfig.projectId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º projectId –∫–∞–∫ appId
        // -----------------------------------------------------------------

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const userIdDisplay = document.getElementById('user-id-display');
        const requestInput = document.getElementById('request-input');
        const submitRequestBtn = document.getElementById('submit-request-btn');
        const deleteRequestBtn = document.getElementById('delete-request-btn');
        const requestDisplay = document.getElementById('request-display');
        const requestDetailsDisplay = document.getElementById('request-details-display');
        const requestStatusTag = document.getElementById('request-status-tag');
        const newRequestForm = document.getElementById('new-request-form');
        const currentServerMessageEl = document.getElementById('current-server-message');
        const offlineMessageEl = document.getElementById('offline-message');
        const myRequestCard = document.getElementById('my-request-card');
        const imReadyBtn = document.getElementById('im-ready-btn');
        const readyToReceiveActions = document.getElementById('ready-to-receive-actions');
        const formHeaderMessageEl = document.getElementById('form-header-message');

        // –ö–∞—Ä—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const STATUS_MAP = {
            pending: "–í –û–ñ–ò–î–ê–ù–ò–ò",
            in_progress: "–í –†–ê–ë–û–¢–ï",
            ready_to_receive: "–ì–û–¢–û–í–û –ö –ü–û–õ–£–ß–ï–ù–ò–Æ",
            client_ready: "–ö–õ–ò–ï–ù–¢ –í –ò–ì–†–ï",
            completed: "–ó–ê–í–ï–†–®–ï–ù–û"
        };
        // –ö–ª–∞—Å—Å—ã —Å—Ç–∏–ª–µ–π
        const STATUS_CLASSES = {
            pending: "status-pending",
            in_progress: "status-in_progress",
            ready_to_receive: "status-ready_to_receive",
            client_ready: "status-client_ready",
            completed: "status-completed"
        };
        
        // --- –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ –≤–º–µ—Å—Ç–æ alert/confirm ---
        function showCustomMessage(message) {
            const container = document.getElementById('custom-modal-container');
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <p class="text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end">
                            <button id="modal-ok" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150">
                                –û–ö
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalOk = document.getElementById('modal-ok');
            modalOk.onclick = () => {
                container.innerHTML = ''; // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            };
        }
        
        // --- 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
        async function initializeFirebase() {
            setLogLevel('Debug');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–ª—é—á–∏ Firebase –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
            if (firebaseConfig.apiKey.includes('**–í–°–¢–ê–í–¨–¢–ï')) {
                 showCustomMessage("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–ª—é—á–∏ Firebase Config –≤ –∫–æ–¥–µ index.html.");
                 return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –ü—É—Ç—å –∫ –ø—É–±–ª–∏—á–Ω—ã–º –¥–∞–Ω–Ω—ã–º
                const publicDataPath = `artifacts/${appId}/public/data`;
                statusDocRef = doc(db, `${publicDataPath}/app_status/admin_online`);

                // –í–∞–∂–Ω–æ: –ñ–¥–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ), –≤—Ö–æ–¥–∏–º –∞–Ω–æ–Ω–∏–º–Ω–æ
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                    }

                    // *** –ó–ê–ü–£–°–ö –ü–û–î–ü–ò–°–û–ö –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ô –ê–£–¢–ï–ù–¢–ò–ö–ê–¶–ò–ò ***
                    if (userId) {
                        userIdDisplay.textContent = userId;
                        // –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: requests_queue/UID_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        userDocRef = doc(db, `${publicDataPath}/requests_queue`, userId);
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
                        loadStatus();
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞—è–≤–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        loadMyRequest();
                    }
                });

            } catch (error) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                showCustomMessage(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ Firebase.`);
            }
        }
        
        // --- 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ ---
        function loadStatus() {
            onSnapshot(statusDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isServerOnline = data.isOnline || false;
                    const message = data.message || (isServerOnline ? "–†–∞–∑–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞" : "–†–∞–∑–¥–∞—á–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
                    
                    currentServerMessageEl.innerHTML = isServerOnline 
                        ? `<span class="text-green-600 font-bold">–û–ù–õ–ê–ô–ù: ${message}</span>` 
                        : `<span class="text-red-500 font-bold">–û–§–§–õ–ê–ô–ù: ${message}</span>`;
                        
                    if (!isServerOnline) {
                        offlineMessageEl.classList.remove('hidden');
                        submitRequestBtn.disabled = false; 
                        formHeaderMessageEl.classList.add('hidden');
                    } else {
                        offlineMessageEl.classList.add('hidden');
                    }
                }
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞:", error);
                currentServerMessageEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞.";
            });
        }

        // --- 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
        function loadMyRequest() {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const requestData = docSnap.data();
                    displayRequest(requestData, docSnap.id);
                    
                    // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –≤ Firestore
                    if (requestData.status === 'completed') {
                        // –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
                        setTimeout(async () => {
                            try {
                                await deleteDoc(userDocRef); // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
                                showCustomMessage("–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏. –°–ø–∞—Å–∏–±–æ!");
                            } catch (e) {
                                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏:", e);
                            }
                        }, 5000); 
                    }
                    
                } else {
                    displayNewRequestForm(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                }
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:", error);
            });
        }

        // --- 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏ ---
        function displayRequest(data) {
            newRequestForm.classList.add('hidden');
            requestDisplay.classList.remove('hidden');
            deleteRequestBtn.classList.remove('hidden');
            myRequestCard.classList.remove('border-blue-500');
            
            requestDetailsDisplay.textContent = data.requestDetails;
            
            const statusText = STATUS_MAP[data.status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const statusClass = STATUS_CLASSES[data.status] || 'status-completed';
            
            requestStatusTag.className = `status-tag ${statusClass}`;
            requestStatusTag.textContent = statusText;
            
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ì–æ—Ç–æ–≤ –∑–∞–±—Ä–∞—Ç—å"
            if (data.status === 'ready_to_receive') {
                myRequestCard.classList.add('border-green-500', 'border-4');
                readyToReceiveActions.classList.remove('hidden');
                imReadyBtn.disabled = false;
            } else if (data.status === 'client_ready') {
                 myRequestCard.classList.add('border-purple-500', 'border-4');
                 readyToReceiveActions.classList.remove('hidden');
                 imReadyBtn.disabled = true;
                 imReadyBtn.textContent = '–ê–¥–º–∏–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –≤ –∏–≥—Ä–µ!';
            } 
            else {
                myRequestCard.classList.remove('border-green-500', 'border-purple-500', 'border-4');
                readyToReceiveActions.classList.add('hidden');
            }
        }

        // --- 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ ---
        function displayNewRequestForm() {
            requestDisplay.classList.add('hidden');
            deleteRequestBtn.classList.add('hidden');
            newRequestForm.classList.remove('hidden');
            requestInput.value = ''; // –û—á–∏—Å—Ç–∫–∞
            submitRequestBtn.disabled = false;
            submitRequestBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞—è–≤–∫—É –≤ –û—á–µ—Ä–µ–¥—å';
            myRequestCard.classList.remove('border-green-500', 'border-purple-500', 'border-4');
            formHeaderMessageEl.classList.add('hidden');
            imReadyBtn.disabled = false;
            imReadyBtn.textContent = '–Ø –≤ –∏–≥—Ä–µ, –≥–æ—Ç–æ–≤ –∑–∞–±—Ä–∞—Ç—å!';
        }

        // --- 6. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ ---
        submitRequestBtn.addEventListener('click', async () => {
            const details = requestInput.value.trim();
            if (details.length < 10) {
                showCustomMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∑–∞—è–≤–∫—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤).");
                return;
            }

            submitRequestBtn.disabled = true;
            submitRequestBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                // –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç —Å ID, —Ä–∞–≤–Ω—ã–º UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await setDoc(userDocRef, {
                    subscriberId: userId, // ID, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω –¥–ª—è —Å–≤—è–∑–∏
                    requestDetails: details,
                    status: 'pending',
                    createdAt: new Date(),
                    addedBy: 'client' // –ü–æ–º–µ—Ç–∫–∞ –æ —Ç–æ–º, –∫—Ç–æ –¥–æ–±–∞–≤–∏–ª (–¥–ª—è –∞–¥–º–∏–Ω–∞)
                });
                showCustomMessage("–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å!");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:", error);
                showCustomMessage(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ${error.message}`);
                submitRequestBtn.disabled = false;
                submitRequestBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞—è–≤–∫—É –≤ –û—á–µ—Ä–µ–¥—å';
            }
        });
        
        // --- 7. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å –ó–∞—è–≤–∫—É" ---
        deleteRequestBtn.addEventListener('click', async () => {
             // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π confirm –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏
            const isConfirmed = await window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ—é –∑–∞—è–≤–∫—É –∏–∑ –æ—á–µ—Ä–µ–¥–∏?");
            if (isConfirmed) {
                 deleteRequestBtn.disabled = true;
                 deleteRequestBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
                try {
                    await deleteDoc(userDocRef);
                    showCustomMessage("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:", error);
                    showCustomMessage(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ${error.message}`);
                } finally {
                     deleteRequestBtn.disabled = false;
                     deleteRequestBtn.textContent = '–£–¥–∞–ª–∏—Ç—å –ó–∞—è–≤–∫—É';
                }
            }
        });
        
        // --- 8. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–Ø –≤ –∏–≥—Ä–µ, –≥–æ—Ç–æ–≤ –∑–∞–±—Ä–∞—Ç—å!" ---
        imReadyBtn.addEventListener('click', async () => {
            imReadyBtn.disabled = true;
            imReadyBtn.textContent = '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞...';

            try {
                await updateDoc(userDocRef, {
                    status: 'client_ready',
                    clientReadyAt: new Date(),
                    lastUpdated: new Date()
                });
                 showCustomMessage("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω, —á—Ç–æ –≤—ã –≥–æ—Ç–æ–≤—ã –∑–∞–±—Ä–∞—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:", error);
                showCustomMessage(`–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`);
            }
        });

        // –ó–∞–º–µ–Ω–∞ alert –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –æ–∫–Ω–æ
        window.alert = showCustomMessage;
        window.confirm = (message) => {
            return new Promise(resolve => {
                const container = document.getElementById('custom-modal-container');
                container.innerHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <p class="text-gray-800 mb-4">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 transition duration-150">–û—Ç–º–µ–Ω–∞</button>
                                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modal-cancel').onclick = () => {
                    container.innerHTML = '';
                    resolve(false);
                };
                document.getElementById('modal-confirm').onclick = () => {
                    container.innerHTML = '';
                    resolve(true);
                };
            });
        };
        
        // --- –ó–∞–ø—É—Å–∫ ---
        initializeFirebase();

    </script>
</body>
</html>
