<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏: Car Parking Multiplayer</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem; 
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .status-pending { background-color: #FBBF24; color: #422006; } /* amber */
        .status-in_progress { background-color: #3B82F6; color: #EFF6FF; } /* blue */
        .status-ready_to_receive { background-color: #10B981; color: #ECFDF5; } /* green - –ì–æ—Ç–æ–≤–æ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é */
        .status-client_ready { background-color: #9333ea; color: #ffffff; } /* purple - –ö–ª–∏–µ–Ω—Ç –≤ –∏–≥—Ä–µ */
        .status-completed { background-color: #4B5563; color: #E5E7EB; } /* gray */
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            min-width: 300px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-xl mx-auto">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-700">–ó–∞—è–≤–∫–∏ Car Parking Multiplayer</h1>
            <p class="text-gray-500 font-medium mt-2">–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞—à–∏–Ω –∏–ª–∏ –¥–µ–Ω–µ–≥</p>
            <p class="text-sm text-gray-400 mt-1">
                <a href="admin/index.html" class="text-indigo-500 hover:text-indigo-700 hover:underline">‚Üí –ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            </p>
        </header>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-indicator" class="text-center p-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-indigo-600 font-medium">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="main-app-content" class="hidden">
            
            <!-- –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ -->
            <div id="server-status-box" class="p-4 rounded-lg mb-6 shadow-md text-center">
                <p class="font-bold text-lg" id="server-status-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</p>
                <p class="text-sm text-gray-600 mt-1" id="server-message-text"></p>
            </div>

            <!-- –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ (–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏) -->
            <div id="request-form-container" class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-indigo-500 hidden">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700">–ù–æ–≤–∞—è –ó–∞—è–≤–∫–∞</h2>
                
                <!-- ID –ò–≥—Ä–æ–∫–∞ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ) -->
                <div class="mb-4">
                    <label for="subscriber-id" class="block text-sm font-medium text-gray-700 mb-1">
                        –í–∞—à ID –∏–≥—Ä–æ–∫–∞ (AA123456 –∏–ª–∏ 7-8 —Ü–∏—Ñ—Ä):
                    </label>
                    <input type="text" id="subscriber-id" placeholder="AA123456" maxlength="8"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                    <p id="id-error" class="text-xs text-red-500 mt-1 hidden">–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ AA123456 –∏–ª–∏ 7-8 —Ü–∏—Ñ—Ä.</p>
                </div>
                
                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞ -->
                <div class="mb-6">
                    <span class="block text-sm font-medium text-gray-700 mb-2">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å?</span>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="request-type" value="car" id="type-car" class="form-radio text-indigo-600" checked>
                            <span class="ml-2 text-gray-700">–ú–∞—à–∏–Ω–∞</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="request-type" value="money" id="type-money" class="form-radio text-indigo-600">
                            <span class="ml-2 text-gray-700">–î–µ–Ω—å–≥–∏</span>
                        </label>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ –¥–ª—è –ú–∞—à–∏–Ω—ã -->
                <div id="car-fields" class="space-y-4">
                    <div class="mb-4">
                        <label for="car-model" class="block text-sm font-medium text-gray-700 mb-1">–ú–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã:</label>
                        <input type="text" id="car-model" placeholder="BMW M5 F90 (2021)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="car-photo-link" class="block text-sm font-medium text-gray-700 mb-1">
                            –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç (–∏–ª–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ):
                        </label>
                        <textarea id="car-photo-link" rows="2" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Imgur, –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —Ç—é–Ω–∏–Ω–≥: —Ü–≤–µ—Ç —Å–∏–Ω–∏–π –º–µ—Ç–∞–ª–ª–∏–∫, 3000HP, –≤–∏–Ω–∏–ª ‚Ññ123"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            *–ú—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ñ–∞–π–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
                        </p>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ –¥–ª—è –î–µ–Ω–µ–≥ (–°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="money-fields" class="space-y-4 hidden">
                    <div class="mb-4">
                        <label for="money-amount" class="block text-sm font-medium text-gray-700 mb-1">
                            –°—É–º–º–∞ (–Ω–µ –±–æ–ª–µ–µ 50 000 000):
                        </label>
                        <input type="number" id="money-amount" placeholder="50000000" min="1000000" max="50000000"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <p id="money-error" class="text-xs text-red-500 mt-1 hidden">–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –º–ª–Ω –¥–æ 50 –º–ª–Ω.</p>
                    </div>
                </div>

                <button id="submit-request-btn" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞—è–≤–∫—É
                </button>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏ (–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞) -->
            <div id="current-request-container" class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-yellow-500 hidden">
                <h2 class="text-2xl font-bold mb-4 text-indigo-700">–í–∞—à–∞ –ê–∫—Ç–∏–≤–Ω–∞—è –ó–∞—è–≤–∫–∞</h2>
                
                <div id="request-display" class="space-y-3">
                    <p class="text-sm text-gray-600">ID –∏–≥—Ä–æ–∫–∞: <span id="display-id" class="font-mono font-bold text-gray-800"></span></p>
                    <p class="text-sm text-gray-600">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <span id="display-time" class="font-medium text-gray-800"></span></p>
                    <p class="text-sm text-gray-600">–ó–∞–ø—Ä–æ—Å: <span id="display-details" class="font-medium text-gray-800"></span></p>
                    <div class="border-t pt-3">
                        <p class="text-xl font-bold">–¢–µ–∫—É—â–∏–π –°—Ç–∞—Ç—É—Å:</p>
                        <span id="display-status-tag" class="status-tag"></span>
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ ready_to_receive) -->
                <div id="client-ready-action" class="mt-6 p-4 bg-green-100 rounded-lg border border-green-400 hidden">
                    <p class="text-green-800 font-bold mb-3">üî• –í–∞—à –∑–∞–∫–∞–∑ –ì–û–¢–û–í! –ó–∞—Ö–æ–¥–∏—Ç–µ –≤ –∏–≥—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è.</p>
                    <button id="ready-to-receive-btn" class="w-full py-3 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">
                        –Ø –ì–û–¢–û–í –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ (–Ø –≤ –∏–≥—Ä–µ)
                    </button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞—è–≤–∫–∏ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ì–æ—Ç–æ–≤–æ") -->
                <button id="cancel-request-btn" class="mt-6 w-full py-3 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 disabled:opacity-50">
                    –û—Ç–º–µ–Ω–∏—Ç—å –ó–∞—è–≤–∫—É
                </button>
            </div>

        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <div id="custom-modal-container"></div>

    <!-- –ú–æ–¥—É–ª—å Firebase -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            deleteDoc,
            updateDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let db;
        let auth;
        let userId = null; 
        let currentRequest = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
        const QUEUE_COLLECTION = 'requests_queue';
        const STATUS_DOC = 'admin_online';
        
        // --- !!! –í–ê–ñ–ù–û: –í–ê–®–ò –ö–õ–Æ–ß–ò FIREBASE !!! ---
        // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
        const firebaseConfig = {
            apiKey: "AIzaSyBw_8Dx9gUI5tsUXSqX4Jd8hfjU4pNZGI8",
                    authDomain: "cpm-giveaway.firebaseapp.com",
                    projectId: "cpm-giveaway", 
        };
        const appId = firebaseConfig.projectId; 
        const publicDataPath = `artifacts/${appId}/public/data`;
        const myRequestPath = `artifacts/${appId}/users`; // –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—É–±–ª–∏—á–Ω—É—é –∑–∞—è–≤–∫—É)

        // –ö–∞—Ä—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const STATUS_MAP = {
            pending: "–í –û–ñ–ò–î–ê–ù–ò–ò",
            in_progress: "–í –†–ê–ë–û–¢–ï",
            ready_to_receive: "–ì–û–¢–û–í–û –ö –ü–û–õ–£–ß–ï–ù–ò–Æ", 
            client_ready: "–û–ñ–ò–î–ê–ï–¢–°–Ø: –ö–õ–ò–ï–ù–¢ –í –ò–ì–†–ï", 
            completed: "–ó–ê–í–ï–†–®–ï–ù–û/–£–î–ê–õ–ï–ù–û"
        };
        // –ö–ª–∞—Å—Å—ã —Å—Ç–∏–ª–µ–π
        const STATUS_CLASSES = {
            pending: "status-pending",
            in_progress: "status-in_progress",
            ready_to_receive: "status-ready_to_receive",
            client_ready: "status-client_ready",
            completed: "status-completed"
        };
        
        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainAppContent = document.getElementById('main-app-content');
        const serverStatusBox = document.getElementById('server-status-box');
        const serverStatusText = document.getElementById('server-status-text');
        const serverMessageText = document.getElementById('server-message-text');
        
        const requestFormContainer = document.getElementById('request-form-container');
        const currentRequestContainer = document.getElementById('current-request-container');
        const submitRequestBtn = document.getElementById('submit-request-btn');
        const cancelRequestBtn = document.getElementById('cancel-request-btn');
        const readyToReceiveBtn = document.getElementById('ready-to-receive-btn');
        const clientReadyAction = document.getElementById('client-ready-action');
        
        // –§–æ—Ä–º–∞
        const subscriberIdInput = document.getElementById('subscriber-id');
        const idError = document.getElementById('id-error');
        const typeCar = document.getElementById('type-car');
        const typeMoney = document.getElementById('type-money');
        const carFields = document.getElementById('car-fields');
        const moneyFields = document.getElementById('money-fields');
        const carModelInput = document.getElementById('car-model');
        const carPhotoLinkInput = document.getElementById('car-photo-link');
        const moneyAmountInput = document.getElementById('money-amount');
        const moneyError = document.getElementById('money-error');

        // --- –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ –≤–º–µ—Å—Ç–æ alert/confirm ---
        function showCustomMessage(message, isImportant = false) {
            const container = document.getElementById('custom-modal-container');
            const borderColor = isImportant ? 'border-red-500' : 'border-indigo-500';
            const buttonColor = isImportant ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700';

            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content border-t-4 ${borderColor}">
                        <p class="text-gray-800 mb-4 font-medium">${message}</p>
                        <div class="flex justify-end">
                            <button id="modal-ok" class="px-4 py-2 ${buttonColor} text-white font-medium rounded-lg transition duration-150">
                                –û–ö
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalOk = document.getElementById('modal-ok');
            modalOk.onclick = () => {
                container.innerHTML = ''; // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            };
        }
        
        // --- 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
        async function initializeFirebase() {
            setLogLevel('Debug');
            loadingIndicator.classList.remove('hidden');

            if (firebaseConfig.apiKey.includes('**–í–°–¢–ê–í–¨–¢–ï')) {
                 loadingIndicator.innerHTML = `<p class="mt-4 text-red-600 font-bold">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–ª—é—á–∏ Firebase Config.</p>`;
                 return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: –∂–¥–µ–º, –ø–æ–∫–∞ Firebase –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; 
                    } else {
                        // –í—Ö–æ–¥–∏–º –∞–Ω–æ–Ω–∏–º–Ω–æ
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
                    loadingIndicator.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');

                    // –ó–ê–ü–£–°–ö –ü–û–î–ü–ò–°–û–ö
                    if (userId) {
                        loadStatus();
                        loadMyRequest();
                    }
                });

            } catch (error) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                loadingIndicator.innerHTML = `<p class="mt-4 text-red-600 font-bold">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ Firebase –∏ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!</p>`;
            }
        }

        // --- 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ ---
        function loadStatus() {
            const statusDocRef = doc(db, `${publicDataPath}/app_status`, STATUS_DOC);
            onSnapshot(statusDocRef, (docSnap) => {
                const isOnline = docSnap.data()?.isOnline || false;
                const message = docSnap.data()?.message || (isOnline ? "–†–∞–∑–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞" : "–†–∞–∑–¥–∞—á–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
                
                serverStatusBox.classList.toggle('bg-green-200', isOnline);
                serverStatusBox.classList.toggle('bg-red-200', !isOnline);
                serverStatusText.textContent = isOnline ? "‚úÖ –°–µ—Ä–≤–µ—Ä –û–ù–õ–ê–ô–ù" : "üõë –°–µ—Ä–≤–µ—Ä –û–§–§–õ–ê–ô–ù";
                serverStatusText.classList.toggle('text-green-800', isOnline);
                serverStatusText.classList.toggle('text-red-800', !isOnline);
                serverMessageText.textContent = message;
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞:", error);
            });
        }
        
        // --- 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
        function loadMyRequest() {
            // –ó–∞—è–≤–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–æ –º—ã –∏—â–µ–º –µ–µ –ø–æ ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const queueCollectionRef = collection(db, `${publicDataPath}/${QUEUE_COLLECTION}`);
            // –ò—â–µ–º –∑–∞—è–≤–∫—É, –≥–¥–µ userId —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—à–∏–º
            const q = query(queueCollectionRef, where("userId", "==", userId));
            
            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.docs.length > 0) {
                    const newRequest = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    if (currentRequest && newRequest.status !== currentRequest.status) {
                        notifyStatusChange(newRequest);
                    }
                    
                    currentRequest = newRequest;
                    displayActiveRequest(currentRequest);
                } else {
                    currentRequest = null;
                    displayRequestForm();
                }
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:", error);
            });
        }

        // --- 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ ---
        function notifyStatusChange(request) {
            const statusText = STATUS_MAP[request.status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
            let message = `üîî –°—Ç–∞—Ç—É—Å –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞: ${statusText}`;
            let isImportant = false;
            
            if (request.status === 'ready_to_receive') {
                message = `üéâ –í–ê–® –ó–ê–ö–ê–ó –ì–û–¢–û–í! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–Ø –ì–û–¢–û–í –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑", –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≤ –∏–≥—Ä–µ.`;
                isImportant = true;
            } else if (request.status === 'in_progress') {
                message = `üîß –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É. –°–∫–æ—Ä–æ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞!`;
            }
            
            showCustomMessage(message, isImportant);
        }

        // --- 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã/—Å—Ç–∞—Ç—É—Å–∞ ---
        function displayActiveRequest(request) {
            requestFormContainer.classList.add('hidden');
            currentRequestContainer.classList.remove('hidden');
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            document.getElementById('display-id').textContent = request.subscriberId;
            document.getElementById('display-time').textContent = request.createdAt.toDate().toLocaleString('ru-RU');
            document.getElementById('display-details').textContent = request.requestDetails;
            
            const statusTagEl = document.getElementById('display-status-tag');
            statusTagEl.textContent = STATUS_MAP[request.status];
            statusTagEl.className = `status-tag ${STATUS_CLASSES[request.status]}`;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
            if (request.status === 'ready_to_receive') {
                clientReadyAction.classList.remove('hidden');
                cancelRequestBtn.disabled = false; // –û—Ç–º–µ–Ω—É –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            } else if (request.status === 'client_ready') {
                clientReadyAction.classList.remove('hidden');
                readyToReceiveBtn.textContent = '–û–ñ–ò–î–ê–ù–ò–ï –ê–î–ú–ò–ù–ê... (–ù–µ –Ω–∞–∂–∏–º–∞–π—Ç–µ)';
                readyToReceiveBtn.disabled = true;
                cancelRequestBtn.disabled = true;
            } else {
                clientReadyAction.classList.add('hidden');
                cancelRequestBtn.disabled = false;
            }
            
            // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–Ω–æ–≤–∞
            if (request.status === 'completed') {
                showCustomMessage("–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏!");
                currentRequest = null;
                displayRequestForm();
            }
        }

        function displayRequestForm() {
            currentRequestContainer.classList.add('hidden');
            requestFormContainer.classList.remove('hidden');
            // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            subscriberIdInput.value = '';
            carModelInput.value = '';
            carPhotoLinkInput.value = '';
            moneyAmountInput.value = '';
            typeCar.checked = true;
            toggleRequestType();
        }

        // --- 6. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –û—Ç–ø—Ä–∞–≤–∫–∞ –ó–∞—è–≤–∫–∏ ---
        function validateAndSubmit() {
            const subscriberId = subscriberIdInput.value.trim().toUpperCase();
            const isCar = typeCar.checked;
            let isValid = true;
            let requestDetails = '';

            // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è ID
            // –ü–∞—Ç—Ç–µ—Ä–Ω: AA123456 (2 –±—É–∫–≤—ã, 6 —Ü–∏—Ñ—Ä) –ò–õ–ò 7-8 —Ü–∏—Ñ—Ä
            const idPattern = /^([A-Z]{2}\d{6}|\d{7,8})$/;
            if (!idPattern.test(subscriberId)) {
                idError.classList.remove('hidden');
                isValid = false;
            } else {
                idError.classList.add('hidden');
            }
            
            // 2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
            if (isCar) {
                const model = carModelInput.value.trim();
                const photo = carPhotoLinkInput.value.trim();
                
                if (!model) {
                    showCustomMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã.");
                    isValid = false;
                }
                
                if (isValid) {
                    requestDetails = `–ú–∞—à–∏–Ω–∞: ${model}. –î–µ—Ç–∞–ª–∏/–§–æ—Ç–æ: ${photo || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π/—Å—Å—ã–ª–∫–∏'}`;
                }
            } else { // –î–µ–Ω—å–≥–∏
                const amount = parseInt(moneyAmountInput.value);
                const maxAmount = 50000000;
                const minAmount = 1000000;

                if (isNaN(amount) || amount < minAmount || amount > maxAmount) {
                    moneyError.classList.remove('hidden');
                    showCustomMessage(`–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç ${minAmount.toLocaleString('ru-RU')} –¥–æ ${maxAmount.toLocaleString('ru-RU')} –º–æ–Ω–µ—Ç.`, true);
                    isValid = false;
                } else {
                    moneyError.classList.add('hidden');
                }
                
                if (isValid) {
                    requestDetails = `–î–µ–Ω—å–≥–∏: ${amount.toLocaleString('ru-RU')} (ID: ${subscriberId})`;
                }
            }
            
            if (isValid) {
                submitRequestBtn.disabled = true;
                sendRequestToFirestore(subscriberId, requestDetails);
            }
        }

        async function sendRequestToFirestore(subscriberId, requestDetails) {
            try {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É –≤ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                const requestDocRef = collection(db, `${publicDataPath}/${QUEUE_COLLECTION}`);
                
                await addDoc(requestDocRef, {
                    userId: userId, // ID Firebase –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                    subscriberId: subscriberId, // ID –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    requestDetails: requestDetails,
                    status: 'pending',
                    createdAt: new Date(),
                    lastUpdated: new Date(),
                });
                
                showCustomMessage("‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.");
                // onSnapshot –≤ loadMyRequest –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç UI
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏:", error);
                showCustomMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}`, true);
            } finally {
                submitRequestBtn.disabled = false;
            }
        }

        // --- 7. –û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏ ---
        cancelRequestBtn.addEventListener('click', async () => {
            if (!currentRequest) return;
            
            const isConfirmed = await window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?");
            if (isConfirmed) {
                cancelRequestBtn.disabled = true;
                try {
                    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    const docRef = doc(db, `${publicDataPath}/${QUEUE_COLLECTION}`, currentRequest.id);
                    await deleteDoc(docRef);
                    showCustomMessage("–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏.");
                    // loadMyRequest –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–æ—Å–∏—Ç UI
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞—è–≤–∫–∏:", error);
                    showCustomMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ: ${error.message}`, true);
                } finally {
                    cancelRequestBtn.disabled = false;
                }
            }
        });
        
        // --- 8. –ö–Ω–æ–ø–∫–∞ "–Ø –≥–æ—Ç–æ–≤ –ø–æ–ª—É—á–∏—Ç—å" ---
        readyToReceiveBtn.addEventListener('click', async () => {
             if (!currentRequest || currentRequest.status !== 'ready_to_receive') return;
             
             readyToReceiveBtn.disabled = true;
             try {
                const docRef = doc(db, `${publicDataPath}/${QUEUE_COLLECTION}`, currentRequest.id);
                await updateDoc(docRef, { 
                    status: 'client_ready',
                    clientReadyAt: new Date(),
                    lastUpdated: new Date()
                });
                showCustomMessage("‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω, —á—Ç–æ –≤—ã –≤ –∏–≥—Ä–µ! –û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.");
             } catch (error) {
                 console.error("–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:", error);
                 showCustomMessage(`–û—à–∏–±–∫–∞: ${error.message}`, true);
             } finally {
                readyToReceiveBtn.disabled = false;
             }
        });

        // --- 9. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã ---
        function toggleRequestType() {
            const isCar = typeCar.checked;
            carFields.classList.toggle('hidden', !isCar);
            moneyFields.classList.toggle('hidden', isCar);
            
            // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            idError.classList.add('hidden');
            moneyError.classList.add('hidden');
        }

        document.querySelectorAll('input[name="request-type"]').forEach(radio => {
            radio.addEventListener('change', toggleRequestType);
        });
        
        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        submitRequestBtn.addEventListener('click', validateAndSubmit);

        // –ó–∞–º–µ–Ω–∞ window.confirm
        window.confirm = (message) => {
            return new Promise(resolve => {
                const container = document.getElementById('custom-modal-container');
                container.innerHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <p class="text-gray-800 mb-4">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 transition duration-150">–û—Ç–º–µ–Ω–∞</button>
                                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modal-cancel').onclick = () => {
                    container.innerHTML = '';
                    resolve(false);
                };
                document.getElementById('modal-confirm').onclick = () => {
                    container.innerHTML = '';
                    resolve(true);
                };
            });
        };

        // --- –ó–∞–ø—É—Å–∫ ---
        initializeFirebase();

    </script>
</body>
</html>
