<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель: Управление заявками</title>
    <!-- Подключаем Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Общие стили для меток статуса */
        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            text-transform: uppercase;
        }
        /* Цвета для статусов заявок (Обновлены) */
        .status-pending { background-color: #FBBF24; color: #422006; }
        .status-in_progress { background-color: #3B82F6; color: #EFF6FF; }
        .status-ready-to-receive { background-color: #10B981; color: #ECFDF5; } /* Готово к получению (Админ уведомил) */
        .status-client_ready { background-color: #9333ea; color: #ffffff; } /* Клиент готов забрать (Фиолетовый, ВЫСШИЙ ПРИОРИТЕТ) */
        .status-completed { background-color: #4B5563; color: #E5E7EB; } /* Завершено/Удалено */
        
        /* Эффект при наведении на карточку заявки */
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Стили для кнопок управления */
        .status-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        
        <!-- Заголовок -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700">Админ-панель Car Parking</h1>
            <p class="text-xl text-gray-500">Управление очередью заявок</p>
        </header>

        <!-- Раздел Входа и Статуса -->
        <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-lg border-l-4 border-indigo-500">
            <div id="auth-status-header" class="text-lg font-semibold text-gray-700">
                Статус: Ожидание...
            </div>
            <button id="auth-button" class="px-4 py-2 rounded-lg text-white font-medium transition duration-150 bg-indigo-600 hover:bg-indigo-700">
                Войти через Google
            </button>
        </div>

        <!-- Контейнер основного контента (Скрыт по умолчанию) -->
        <div id="admin-content" class="hidden">
        
            <!-- Раздел Управления Статусом Сервера -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-8 border-t-4 border-indigo-500">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Статус Сервера</h2>
                <div class="flex flex-wrap items-center justify-between gap-4">
                    
                    <!-- Текущий статус -->
                    <div class="flex-grow">
                        <p class="text-sm font-medium text-gray-500">Текущее состояние:</p>
                        <div id="server-status-display" class="text-3xl font-bold">
                            <span class="text-gray-400 animate-pulse">Загрузка...</span>
                        </div>
                    </div>

                    <!-- Поле для сообщения -->
                    <div class="w-full md:w-1/2">
                        <label for="status-message" class="block text-sm font-medium text-gray-700 mb-1">Сообщение для клиентов</label>
                        <input type="text" id="status-message" placeholder="Раздача активна"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Кнопки управления -->
                    <div class="flex space-x-3 mt-2 md:mt-0">
                        <button id="set-online-btn" class="status-btn bg-green-500 text-white hover:bg-green-600 disabled:opacity-50">
                            ВКЛ (ONLINE)
                        </button>
                        <button id="set-offline-btn" class="status-btn bg-red-500 text-white hover:bg-red-600 disabled:opacity-50">
                            ВЫКЛ (OFFLINE)
                        </button>
                    </div>
                </div>
                <div id="status-error" class="text-red-500 text-sm mt-3"></div>
            </div>

            <!-- Раздел Списка Заявок -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Очередь Заявок (<span id="request-count">0</span>)</h2>
                <div id="request-list" class="space-y-4">
                    <!-- Заявки будут добавлены сюда -->
                    <div id="loading-requests" class="text-center py-8 text-gray-500">Загрузка заявок...</div>
                    <div id="no-requests" class="text-center py-8 text-gray-500 hidden">
                        <p class="text-lg">Очередь пуста!</p>
                        <p class="text-sm">Нажмите "ВКЛ (ONLINE)", чтобы начать прием заявок.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Раздел ОТКАЗА В ДОСТУПЕ (Скрыт по умолчанию) -->
        <div id="access-denied" class="hidden text-center p-12 bg-red-100 rounded-lg shadow-lg border-l-8 border-red-500 mt-8">
            <h2 class="text-3xl font-bold text-red-700 mb-4">Доступ Запрещен</h2>
            <p class="text-lg text-red-600">Ваш аккаунт не является администратором этого приложения.</p>
            <p class="text-sm text-red-400 mt-2">
                <span class="font-bold">ID пользователя:</span> <span id="unauthorized-uid"></span>
            </p>
            <p class="text-sm text-red-400 mt-2 font-bold">
                <span class="text-red-700">Скопируйте ID выше</span> и вставьте его в код для получения доступа.
            </p>
        </div>
        
        <div id="auth-info" class="text-xs text-gray-400 mt-6 text-center">
             Статус аутентификации: <span id="auth-status">Подключение...</span>
        </div>
    </div>
    
    <!-- Модуль Firebase -->
    <script type="module">
        // Импортируем необходимые функции Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            setDoc, 
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *** КОНФИГУРАЦИЯ FIREBASE ***
        // Убедитесь, что эта конфигурация соответствует той, что в Клиенте (fix_index.html)
        const FALLBACK_FIREBASE_CONFIG = {
             apiKey: "AIzaSyBw_8Dx9gUI5tsUXSqX4Jd8hfjU4pNZGI8",
                    authDomain: "cpm-giveaway.firebaseapp.com",
                    projectId: "cpm-giveaway", 
        };
        // *****************************
            // --- 0. КОНСТАНТЫ АДМИНИСТРАТОРОВ (АВТОРИЗАЦИЯ) ---
        // !!! КРИТИЧНО: Замените 'YOUR_ADMIN_UID_HERE' на ваш реальный Google UID. 
        // Если вам нужен доступ для нескольких админов, добавьте их ID через запятую.
        const ADMIN_Uids = ['9zjSu0LuCMhKDn7CKAYkqOR6XPy2']; 

        
        // --- Глобальные переменные ---
        let db, auth;
        let userId;
        let appId;
        let requestsCollectionRef; 
        let statusDocRef; 

        // DOM элементы
        const serverStatusDisplayEl = document.getElementById('server-status-display');
        const statusMessageInput = document.getElementById('status-message');
        const setOnlineBtn = document.getElementById('set-online-btn');
        const setOfflineBtn = document.getElementById('set-offline-btn');
        const statusErrorEl = document.getElementById('status-error');
        const requestListEl = document.getElementById('request-list');
        const loadingRequestsEl = document.getElementById('loading-requests');
        const noRequestsEl = document.getElementById('no-requests');
        const requestCountEl = document.getElementById('request-count');
        const authStatusEl = document.getElementById('auth-status');
        
        // UI элементы для авторизации
        const authButton = document.getElementById('auth-button');
        const authStatusHeader = document.getElementById('auth-status-header');
        const adminContent = document.getElementById('admin-content');
        const accessDenied = document.getElementById('access-denied');
        const unauthorizedUidEl = document.getElementById('unauthorized-uid');
        
        // Карта статусов для отображения (ОБНОВЛЕНА)
        const STATUS_MAP = {
            pending: "В ОЖИДАНИИ",
            in_progress: "В РАБОТЕ",
            ready_to_receive: "ГОТОВО (К ПОЛУЧЕНИЮ)", // Статус, когда админ уведомил
            client_ready: "КЛИЕНТ ГОТОВ ЗАБРАТЬ", // Новый статус: клиент уведомил админа
            completed: "ЗАВЕРШЕНО/УДАЛИТЬ"
        };
        // Классы стилей (ОБНОВЛЕНЫ)
        const STATUS_CLASSES = {
            pending: "status-pending",
            in_progress: "status-in_progress",
            ready_to_receive: "status-ready-to-receive", 
            client_ready: "status-client_ready", 
            completed: "status-completed"
        };
        
        // --- 1. Инициализация Firebase ---
        async function initializeFirebase() {
            setLogLevel('Debug'); 
            authStatusEl.textContent = "Инициализация...";

            try {
                // Пытаемся получить ID приложения из глобальной переменной, иначе используем projectId из конфига
                appId = typeof __app_id !== 'undefined' ? __app_id : FALLBACK_FIREBASE_CONFIG.projectId || 'default-app-id';
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : FALLBACK_FIREBASE_CONFIG;

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("ВАШ_API_KEY")) {
                    authStatusEl.textContent = "ОШИБКА: Проверьте ключи Firebase!";
                    serverStatusDisplayEl.innerHTML = `<span class="text-red-600">ОШИБКА КЛЮЧЕЙ</span>`;
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Формируем пути к коллекциям/документам
                const publicDataPath = `artifacts/${appId}/public/data`;
                requestsCollectionRef = collection(db, `${publicDataPath}/requests_queue`);
                statusDocRef = doc(db, `${publicDataPath}/app_status/admin_online`);
                
                setupAuthAndAuthorization();

            } catch (error) {
                console.error("Критическая ошибка инициализации Firebase:", error);
                authStatusEl.textContent = `КРИТИЧЕСКАЯ ОШИБКА: ${error.message}`;
            }
        }

        // --- 2. Аутентификация и Авторизация ---
        
        function isUserAdmin(uid) {
            // Проверяем, находится ли UID текущего пользователя в списке администраторов
            return ADMIN_Uids.includes(uid); 
        }

        async function handleSignIn() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Ошибка входа через Google:", error);
                statusErrorEl.textContent = `Ошибка входа: ${error.message}`;
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Ошибка выхода:", error);
                statusErrorEl.textContent = `Ошибка выхода: ${error.message}`;
            }
        }

        authButton.addEventListener('click', () => {
            if (auth.currentUser) {
                handleSignOut();
            } else {
                handleSignIn();
            }
        });
        
        async function setupAuthAndAuthorization() {
            authStatusEl.textContent = "Ожидание входа...";
            
            onAuthStateChanged(auth, (user) => {
                
                adminContent.classList.add('hidden');
                accessDenied.classList.add('hidden');
                
                if (user) {
                    userId = user.uid;
                    // Отображаем часть email или UID
                    authStatusHeader.textContent = `Вход как: ${user.email || user.uid.substring(0, 6) + '...'}`;
                    authButton.textContent = 'Выйти';
                    authButton.className = 'px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition duration-150';
                    
                    if (isUserAdmin(userId)) {
                        // ПОЛЬЗОВАТЕЛЬ АВТОРИЗОВАН КАК АДМИН
                        authStatusEl.textContent = `Администратор (ID: ${userId.substring(0, 6)}...)`;
                        adminContent.classList.remove('hidden'); 
                        
                        // Предупреждение о плейсхолдере
                        if (ADMIN_Uids.includes('YOUR_ADMIN_UID_HERE')) {
                            statusErrorEl.textContent = "⚠️ ВНИМАНИЕ! Замените 'YOUR_ADMIN_UID_HERE' на свой ID в коде!";
                        } else {
                            statusErrorEl.textContent = '';
                        }

                        setupServerStatusListener();
                        setupRequestsListener();
                        
                    } else {
                        // ДОСТУП ЗАПРЕЩЕН
                        authStatusEl.textContent = 'Ошибка доступа (не админ)';
                        unauthorizedUidEl.textContent = userId;
                        accessDenied.classList.remove('hidden'); 
                    }
                    
                } else {
                    // ПОЛЬЗОВАТЕЛЬ НЕ АВТОРИЗОВАН
                    userId = null;
                    authStatusHeader.textContent = 'Статус: Не авторизован';
                    authButton.textContent = 'Войти через Google';
                    authButton.className = 'px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition duration-150';
                    authStatusEl.textContent = 'Требуется вход';
                }
            });
        }
        
        // --- 3. Прослушиватель статуса сервера ---
        function setupServerStatusListener() {
            onSnapshot(statusDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const isOnline = data.isOnline || false;
                    const message = data.message || (isOnline ? "Раздача активна" : "Раздача приостановлена");
                    
                    serverStatusDisplayEl.innerHTML = isOnline 
                        ? `<span class="text-green-600">ОНЛАЙН</span>` 
                        : `<span class="text-red-600">ОФФЛАЙН</span>`;
                    statusMessageInput.value = message;
                    
                    // Управление кнопками
                    setOnlineBtn.disabled = isOnline;
                    setOfflineBtn.disabled = !isOnline;

                } else {
                    // Если документ статуса не существует
                    serverStatusDisplayEl.innerHTML = `<span class="text-red-600">ОФФЛАЙН</span>`;
                    statusMessageInput.value = "Раздача приостановлена";
                    setOnlineBtn.disabled = false;
                    setOfflineBtn.disabled = true;
                }
            }, (error) => {
                console.error("Ошибка прослушивания статуса сервера:", error);
                statusErrorEl.textContent = "Ошибка связи с Firestore. Проверьте правила безопасности!";
            });
        }
        
        // --- 4. Прослушиватель очереди заявок ---
        function setupRequestsListener() {
            const requestsQuery = query(requestsCollectionRef); 
            
            loadingRequestsEl.classList.remove('hidden');
            noRequestsEl.classList.add('hidden');
            requestListEl.innerHTML = ''; 

            onSnapshot(requestsQuery, (snapshot) => {
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });

                renderRequests(requests);
                loadingRequestsEl.classList.add('hidden'); 
            }, (error) => {
                console.error("Ошибка прослушивания заявок:", error);
                statusErrorEl.textContent = "Ошибка загрузки списка заявок.";
                loadingRequestsEl.classList.add('hidden');
            });
        }
        
        // --- 5. Отрисовка списка заявок (СОРТИРОВКА ПО ПРИОРИТЕТУ) ---
        function renderRequests(requests) {
            
            // Логика сортировки (Приоритет: client_ready -> ready_to_receive -> in_progress -> pending)
            requests.sort((a, b) => {
                // client_ready - самый высокий приоритет (1), чтобы админ увидел
                const statusOrder = { client_ready: 1, ready_to_receive: 2, in_progress: 3, pending: 4, completed: 5 };
                
                // 1. Сортировка по статусу
                const statusDiff = (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
                if (statusDiff !== 0) return statusDiff;

                // 2. Сортировка по дате (самые старые вверху в рамках одного статуса)
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                return dateA - dateB;
            });
            
            requestListEl.innerHTML = '';
            requestCountEl.textContent = requests.length;

            if (requests.length === 0) {
                noRequestsEl.classList.remove('hidden');
                return;
            }
            noRequestsEl.classList.add('hidden');


            requests.forEach(req => {
                const reqEl = document.createElement('div');
                reqEl.id = `request-${req.id}`;
                
                // Если клиент готов, выделяем карточку фиолетовой рамкой
                const cardClass = req.status === 'client_ready' 
                    ? 'request-card bg-white p-4 rounded-md shadow transition duration-200 border-l-4 border-purple-500 hover:border-purple-700'
                    : 'request-card bg-white p-4 rounded-md shadow transition duration-200 border-l-4 border-indigo-200 hover:border-indigo-400';
                    
                reqEl.className = cardClass;
                
                const statusText = STATUS_MAP[req.status] || 'Неизвестно';
                const statusClass = STATUS_CLASSES[req.status] || 'status-pending';
                const createdAt = req.createdAt?.toDate ? req.createdAt.toDate().toLocaleString('ru-RU') : 'Нет даты';
                
                const subscriberIdentifier = req.subscriberId || 'ID не указано';

                let clientReadyBadge = '';
                if (req.status === 'client_ready') {
                    // Яркий бэйдж для самого высокого приоритета
                    clientReadyBadge = `<span class="text-xs font-bold text-red-700 bg-red-200 px-2 py-1 rounded-full ml-3 animate-pulse">КЛИЕНТ ЖДЕТ В ИГРЕ!</span>`;
                }

                reqEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-xs text-gray-400">ID Заявки Firestore: ${req.id.substring(0, 6)}</p>
                            <h3 class="text-xl font-bold text-indigo-800">
                                Car Parking ID: ${subscriberIdentifier}
                                ${clientReadyBadge}
                            </h3>
                        </div>
                        <span class="status-tag ${statusClass}">${statusText}</span>
                    </div>
                    
                    <p class="text-gray-600 mb-2">
                        <span class="font-medium text-gray-800">Запрос:</span> ${req.requestDetails}
                    </p>
                    <p class="text-xs text-gray-500 mb-4">
                        Добавлено: ${createdAt} (Пользователь: ${req.addedBy.substring(0, 6)}...)
                    </p>
                    
                    <div class="flex flex-wrap gap-2 text-sm">
                        ${createActionButton('pending', req.id, req.status, 'В Ожидании')}
                        ${createActionButton('in_progress', req.id, req.status, 'В Работе')}
                        ${createActionButton('ready_to_receive', req.id, req.status, 'Готово (Уведомить клиента)')}
                        
                        <!-- Кнопка удаления/завершения, всегда доступна -->
                        ${createActionButton('completed', req.id, req.status, 'Завершить/Удалить', true)} 
                    </div>
                `;
                requestListEl.appendChild(reqEl);
            });
        }
        
        // --- Вспомогательная функция для кнопок (ОБНОВЛЕНА) ---
        function createActionButton(newStatus, id, currentStatus, label, isFinal = false) {
            const isCurrent = newStatus === currentStatus;
            const disabledAttr = isCurrent ? 'disabled' : '';
            const bgColor = isFinal ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-200 hover:bg-gray-300';
            const textColor = isFinal ? 'text-white' : 'text-gray-700';
            
            const action = isFinal ? 'delete' : 'update';
            
            // Если заявка client_ready, кнопки in_progress/ready_to_receive/pending не нужны, 
            // так как следующий логичный шаг - завершение (completed).
            if (currentStatus === 'client_ready' && newStatus !== 'completed' && newStatus !== 'client_ready') {
                return '';
            }
            
            // Если текущий статус ready_to_receive, кнопка ready_to_receive должна быть скрыта
            if (currentStatus === 'ready_to_receive' && newStatus === 'ready_to_receive') {
                return ''; 
            }
            
            // Не позволяем переводить из completed во что-либо еще
             if (currentStatus === 'completed' && newStatus !== 'completed') {
                return '';
            }


            return `
                <button data-id="${id}" 
                        data-status="${newStatus}" 
                        data-action="${action}"
                        ${disabledAttr}
                        class="status-btn ${bgColor} ${textColor} text-xs disabled:bg-indigo-100 disabled:text-indigo-400 disabled:cursor-not-allowed">
                    ${label}
                </button>
            `;
        }
        
        // --- 6. Обработчики событий (Обновление статуса/Удаление) ---
        requestListEl.addEventListener('click', async (e) => {
            const btn = e.target.closest('.status-btn');
            if (!btn || btn.disabled) return;

            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');
            const newStatus = btn.getAttribute('data-status');
            
            const docRef = doc(requestsCollectionRef, id);

            btn.disabled = true;
            btn.textContent = '...';

            try {
                if (action === 'delete') {
                    // Удаление - это завершающий статус
                    await deleteDoc(docRef);
                } else {
                    // Обновление статуса
                    const updatePayload = {
                        status: newStatus,
                        lastUpdated: Timestamp.now()
                    };
                    
                    // Если админ переводит в ready_to_receive, сбрасываем clientReadyAt, если он был
                    if (newStatus === 'ready_to_receive') {
                        updatePayload.clientReadyAt = null; 
                    }
                    
                    await updateDoc(docRef, updatePayload);
                }
            } catch (error) {
                console.error(`Ошибка при ${action} заявки ${id}:`, error);
                statusErrorEl.textContent = `Ошибка при обновлении заявки: ${error.message}`;
            } finally {
                 // onSnapshot обновит UI, когда изменения будут применены
            }
        });

        // --- 7. Обработчики управления статусом сервера ---
        
        setOnlineBtn.addEventListener('click', () => updateServerStatus(true));
        setOfflineBtn.addEventListener('click', () => updateServerStatus(false));
        
        async function updateServerStatus(isOnline) {
            if (!statusDocRef || !userId) {
                statusErrorEl.textContent = "Ошибка: база данных не инициализирована или пользователь не авторизован.";
                return;
            }
            
            setOnlineBtn.disabled = true;
            setOfflineBtn.disabled = true;

            const message = statusMessageInput.value.trim() || (isOnline ? "Раздача активна" : "Раздача приостановлена");
            
            try {
                // Используем setDoc с merge: true для обновления
                await setDoc(statusDocRef, {
                    isOnline: isOnline,
                    message: message,
                    lastUpdateBy: userId,
                    timestamp: Timestamp.now()
                }, { merge: true });
                
                statusErrorEl.textContent = '';
            } catch (error) {
                console.error("Ошибка обновления статуса сервера:", error);
                statusErrorEl.textContent = `Ошибка: ${error.message}`;
            } finally {
                // Кнопки будут разблокированы через listener onSnapshot
            }
        }

        // --- Запуск ---
        initializeFirebase();

    </script>
</body>
  </html>
